<html>
<head>
    <meta charset="utf-8" />
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>JMMå†…å­˜æ¨¡å‹ | YBLOG</title>

<link rel="shortcut icon" href="https://yeyuan1107.github.io/favicon.ico?v=1657077232781">

<link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://yeyuan1107.github.io/styles/main.css">
<!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css"> -->

<script src="https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets/highlight.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/9.12.0/languages//dart.min.js"></script>

<!-- <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0/moment.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.min.js"></script> -->
<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.css">
    
        <script src="https://cdn.jsdelivr.net/npm/mermaid@9.1.1/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script> 
    
</head>
<body>
<div class="main gt-bg-theme-color-first">
    <nav class="navbar navbar-expand-lg">
    <a class="navbar-brand" href="/">
        <img class="user-avatar" src="/images/avatar.png" alt="å¤´åƒ">
        <div class="site-name gt-c-content-color-first">
            YBLOG
        </div>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" id="changeNavbar">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="text-align: center">
            
            <div class="nav-item">
                
                <a href="/" class="menu gt-a-link">
                    é¦–é¡µ
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/archives" class="menu gt-a-link">
                    å½’æ¡£
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/tags" class="menu gt-a-link">
                    æ ‡ç­¾
                </a>
                
            </div>
            
            <div class="nav-item">
                
                <a href="/post/about" class="menu gt-a-link">
                    å…³äº
                </a>
                
            </div>
            
        </div>
        <div style="text-align: center">
            <form id="gridea-search-form" style="position: relative" data-update="1657077232781"
                action="/search/">
                <input class="search-input" autocomplete="off" spellcheck="false" name="q" placeholder="æœç´¢æ–‡ç« " />
                <i class="fas fa-search gt-c-content-color-first" style="position: absolute; top: 9px; left: 10px;"></i>
            </form>
        </div>
    </div>
</nav>
<script>
    /* ç§»åŠ¨ç«¯å¯¼èˆªæ å±•å¼€/æ”¶èµ·åˆ‡æ¢ */
    document.getElementById('changeNavbar').onclick = () => {
        var element = document.getElementById('navbarSupportedContent');
        if (element.style.display === 'none' || element.style.display === '') {
            element.style.display = 'block';
        } else {
            element.style.display = 'none';
        }
    }
</script>

    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    JMMå†…å­˜æ¨¡å‹
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        Â· 2022-02-27 Â·
                    </time>
                    
                        <a href="https://yeyuan1107.github.io/tag/hAPdG4Pk-/" class="post-tags">
                            # JVM
                        </a>
                    
                </div>
                <div class="post-content">
                    <p><a name="anXft"></a></p>
<h2 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h2>
<p><code>sychronized(åŒæ­¥å…³é”®å­—)</code><br />è¯­æ³•</p>
<pre><code class="language-java">synchronized( å¯¹è±¡ ) { 
    è¦ä½œä¸ºåŸå­æ“ä½œä»£ç 
}
</code></pre>
<p>ç”¨<code>synchronized</code>è§£å†³å¹¶å‘é—®é¢˜</p>
<pre><code class="language-java">static int i = 0;
static Object obj = new Object();
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread(() -&gt; {
        for (int j = 0; j &lt; 5000; j++) {
            synchronized (obj) {
                i++; }
        }
    });
    Thread t2 = new Thread(() -&gt; {
        for (int j = 0; j &lt; 5000; j++) {
            synchronized (obj) {
                i--;
            } 
        }
    });
    t1.start();
    t2.start();
    t1.join();
    t2.join();
    System.out.println(i);
}
</code></pre>
<p>å¦‚ä½•ç†è§£å‘¢:ä½ å¯ä»¥æŠŠ obj æƒ³è±¡æˆä¸€ä¸ªæˆ¿é—´ï¼Œçº¿ç¨‹ t1ï¼Œt2 æƒ³è±¡æˆä¸¤ä¸ªäººã€‚ <br />å½“çº¿ç¨‹ t1 æ‰§è¡Œåˆ° synchronized(obj) æ—¶å°±å¥½æ¯” t1 è¿›å…¥äº†è¿™ä¸ªæˆ¿é—´ï¼Œå¹¶åæ‰‹é”ä½äº†é—¨ï¼Œåœ¨é—¨å†…æ‰§è¡Œcount++ ä»£ç ã€‚ <br />è¿™æ—¶å€™å¦‚æœ t2 ä¹Ÿè¿è¡Œåˆ°äº† synchronized(obj) æ—¶ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…ã€‚<br />å½“ t1 æ‰§è¡Œå®Œ synchronized{} å—å†…çš„ä»£ç ï¼Œè¿™æ—¶å€™æ‰ä¼šè§£å¼€é—¨ä¸Šçš„é”ï¼Œä» obj æˆ¿é—´å‡ºæ¥ã€‚t2 çº¿ç¨‹è¿™æ—¶æ‰ å¯ä»¥è¿›å…¥ obj æˆ¿é—´ï¼Œåé”ä½é—¨ï¼Œæ‰§è¡Œå®ƒçš„ count-- ä»£ç ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šä¸Šä¾‹ä¸­ t1 å’Œ t2 çº¿ç¨‹å¿…é¡»ç”¨ synchronized é”ä½åŒä¸€ä¸ª obj å¯¹è±¡ï¼Œå¦‚æœ t1 é”ä½çš„æ˜¯ m1 å¯¹ è±¡ï¼Œt2 é”ä½çš„æ˜¯ m2 å¯¹è±¡ï¼Œå°±å¥½æ¯”ä¸¤ä¸ªäººåˆ†åˆ«è¿›å…¥äº†ä¸¤ä¸ªä¸åŒçš„æˆ¿é—´ï¼Œæ²¡æ³•èµ·åˆ°åŒæ­¥çš„æ•ˆæœã€‚</p>
</blockquote>
<ul>
<li>æ¯ä¸ªç±»å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªMonitoråŒºï¼Œåªæœ‰åœ¨ä½¿ç”¨<code>synchronizedå…³é”®å­—</code>æ‰ç”Ÿæ•ˆ</li>
<li>Ownerè¡¨ç¤ºMonitorçš„æ‰€æœ‰è€…ï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æˆä¸ºOwner
<ul>
<li>å½“ä¸€ä¸ªçº¿ç¨‹t1åˆ°è¾¾ï¼Œå‘ç°Ownerä¸ºç©ºçš„ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°±ä¼šæˆä¸ºOwnerï¼Œå¹¶ä¸”æ‰§è¡Œ<code>monitorenter</code>ä¼šå¯¹Monitorè¿›è¡Œé”å®š</li>
<li>å½“ä¸€ä¸ªçº¿ç¨‹t2åˆ°è¾¾ï¼Œå‘ç°Ownerä¸ä¸ºç©ºï¼Œä¸”é”å®šäº†Monitorï¼Œè¿›å…¥EntryListè¿›è¡Œç­‰å¾…(é˜»å¡)</li>
<li><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646032230273-20f9d2d1-9562-4b2c-a452-6a885fedc887-20220312195457419.png" alt="image.png" loading="lazy"></li>
<li>å½“t1æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œ<code>monitorexit</code>ï¼Œé€šçŸ¥EntryListä¸­æ­£åœ¨ç­‰å¾…çš„çº¿ç¨‹ï¼Œå¯ä»¥æ¥äº‰æŠ¢æˆä¸ºæ–°çš„Owner</li>
<li><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646032367951-68e98a2f-4b68-47a1-a257-f20767f9c163-20220312195457498.png" alt="image.png" loading="lazy"></li>
</ul>
</li>
<li>EntryList</li>
<li>WaitSet<br>
<a name="GEFc1"></a></li>
</ul>
<h1 id="å¯è§æ€§">å¯è§æ€§</h1>
<p><a name="FIv42"></a></p>
<h2 id="é€€ä¸å‡ºçš„å¾ªç¯">é€€ä¸å‡ºçš„å¾ªç¯</h2>
<p>å…ˆæ¥çœ‹ä¸€ä¸ªç°è±¡ï¼Œmain çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢:</p>
<pre><code class="language-java">static boolean run = true;

public static void main(String[] args) throws InterruptedException {
    Thread t = new Thread(()-&gt;{
        while(run){
            // ....
        } 
    });
	t.start();
    
    Thread.sleep(1000);
	run = false; // çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥ 
}
</code></pre>
<p>ä¸ºä»€ä¹ˆå‘¢ï¼Œåˆ†æä¸€ä¸‹å¯çŸ¥</p>
<ol>
<li>åˆå§‹çŠ¶æ€ï¼Œtçº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº†runçš„å€¼åˆ°å·¥ä½œå†…å­˜ï¼Œæ¯æ¬¡å¾ªç¯éƒ½éœ€è¦ä»ä¸»å†…å­˜ä¸­è¯»ä¸€æ¬¡runçš„å€¼</li>
</ol>
<figure data-type="image" tabindex="3"><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646027955406-6a6e180a-fa53-4662-a8ef-820e819eac89-20220312195457562.png" alt="image.png" loading="lazy"></figure>
<ol start="2">
<li>å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡</li>
</ol>
<figure data-type="image" tabindex="4"><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646027980654-54ff16b5-66c5-4779-b3bc-9947169666f7-20220312195457623.png" alt="image.png" loading="lazy"></figure>
<ol start="3">
<li>1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼</li>
</ol>
<p><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646028003664-3197ca78-0ff7-4943-8f1c-f6b1449b5471-20220312195457757.png" alt="image.png" loading="lazy"><br>
<a name="fzTwg"></a></p>
<h2 id="è§£å†³æ–¹æ³•-2">è§£å†³æ–¹æ³•</h2>
<p><code>volatile (æ˜“å˜å…³é”®å­—)</code><br />å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ° ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜<br>
<a name="vL7kO"></a></p>
<h2 id="å¯è§æ€§-2">å¯è§æ€§</h2>
<p>å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ ä¸ªçº¿ç¨‹å¯è§ï¼Œ ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µ: <br />ä¸Šä¾‹ä»å­—èŠ‚ç ç†è§£æ˜¯è¿™æ ·çš„:</p>
<pre><code>getstatic			run //çº¿ç¨‹tè·å–runtrue
getstatic			run //çº¿ç¨‹tè·å–runtrue
getstatic			run //çº¿ç¨‹tè·å–runtrue
getstatic			run //çº¿ç¨‹tè·å–runtrue
putstatic			run // çº¿ç¨‹ main ä¿®æ”¹ run ä¸º falseï¼Œ ä»…æ­¤ä¸€æ¬¡
getstatic			run // çº¿ç¨‹ t è·å– run false
</code></pre>
<p>æ¯”è¾ƒä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å°†çº¿ç¨‹å®‰å…¨æ—¶ä¸¾çš„ä¾‹å­:ä¸¤ä¸ªçº¿ç¨‹ä¸€ä¸ª i++ ä¸€ä¸ª i-- ï¼Œåªèƒ½ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™</p>
<pre><code>// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic				i // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
getstatic				i // çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
iconst_1					// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd							// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1
putstatic				i // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1
iconst_1					// çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1
isub							// çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1
putstatic				i // çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1
</code></pre>
<blockquote>
<p>æ³¨æ„<br>
synchronized è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„åŸå­æ€§ï¼Œä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„å¯è§æ€§ã€‚ä½†ç¼ºç‚¹æ˜¯ synchronizedæ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½</p>
<p>å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ System.out.println() ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹ t ä¹Ÿèƒ½æ­£ç¡®çœ‹åˆ°å¯¹ run å˜é‡çš„ä¿®æ”¹äº†<br>
printlnä¸­æœ‰synchronizedå…³é”®å­—ï¼Œå¼ºåˆ¶å½“å‰çº¿ç¨‹ä»ä¸»å­˜ä¸­è¯»å–å€¼è€Œä¸æ˜¯ä»å‘Šè¯‰ç¼“å­˜ä¸­</p>
</blockquote>
<p><a name="Z6Nwy"></a></p>
<h1 id="æœ‰åºæ€§">æœ‰åºæ€§</h1>
<p><a name="GIZIJ"></a></p>
<h2 id="è¯¡å¼‚çš„ç»“æœ">è¯¡å¼‚çš„ç»“æœ</h2>
<pre><code class="language-java">int num = 0;
boolean ready = false;
// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor1(I_Result r) {
    if(ready) {
        //r1ç”¨æ¥ä¿å­˜ç»“æœ
        r.r1 = num + num;
    } else {
        r.r1 = 1;
    } 
}

// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor2(I_Result r) {
	num = 2;
    ready = true;
}
</code></pre>
<p>I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§?<br />æœ‰åŒå­¦è¿™ä¹ˆåˆ†æ<br />æƒ…å†µ1:çº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1<br />æƒ…å†µ2:çº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1<br />æƒ…å†µ3:çº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4(å› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†)<br />ä½†æˆ‘å‘Šè¯‰ä½ ï¼Œç»“æœè¿˜æœ‰å¯èƒ½æ˜¯ 0 ğŸ˜ğŸ˜ğŸ˜ï¼Œä¿¡ä¸ä¿¡å§!<br />è¿™ç§æƒ…å†µä¸‹æ˜¯:çº¿ç¨‹2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ifåˆ†æ”¯ï¼Œç›¸åŠ ä¸º0ï¼Œå†åˆ‡å›çº¿ç¨‹2æ‰§è¡Œnum = 2<br />ç›¸ä¿¡å¾ˆå¤šäººå·²ç»æ™•äº† ğŸ˜µğŸ˜µğŸ˜µ</p>
<p>è¿™ç§ç°è±¡å«åšæŒ‡ä»¤é‡æ’ï¼Œæ˜¯ JIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°:<br />å€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress <a href="https://wiki.openjdk.java.net/display/CodeTools/jcstress">https://wiki.openjdk.java.net/display/CodeTools/jcstress</a></p>
<pre><code>mvn archetype:generate  -DinteractiveMode=false -
DarchetypeGroupId=org.openjdk.jcstress -DarchetypeArtifactId=jcstress-java-test-
archetype -DgroupId=org.sample -DartifactId=test -Dversion=1.0
</code></pre>
<p>åˆ›å»ºmavené¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»</p>
<pre><code class="language-java">@JCStressTest
//æ£€æŸ¥æ„Ÿå…´è¶£çš„ç»“æœ
@Outcome(id = {&quot;1&quot;, &quot;4&quot;}, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)
@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;!!!!&quot;)
@State
public class ConcurrencyTest {
    int num = 0;
    boolean ready = false;
    @Actor
    public void actor1(I_Result r) {
        if(ready) {
            r.r1 = num + num;
        } else {
            r.r1 = 1;
        } 
    }
	@Actor
    public void actor2(I_Result r) {
        num = 2;
        ready = true;
    }
}
</code></pre>
<p>æ‰§è¡Œ</p>
<pre><code>mvn clean install
java -jar target/jcstress.jar
</code></pre>
<p>ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœ</p>
<pre><code>*** INTERESTING tests
  Some interesting behaviors observed. This is for the plain curiosity.
  2 matching test results.
      [OK] test.ConcurrencyTest
    (JVM args: [-XX:-TieredCompilation])
 Observed state   Occurrences              Expectation  Interpretation
  						0         1,729   ACCEPTABLE_INTERESTING  !!!!
             	1    42,617,915								ACCEPTABLE  ok
             	4     5,146,627								ACCEPTABLE  ok
    [OK] test.ConcurrencyTest
  (JVM args: [])
Observed state   Occurrences							Expectation  Interpretation
             0         1,652   ACCEPTABLE_INTERESTING  !!!!
             1    46,460,657               ACCEPTABLE  ok
             4     4,571,072               ACCEPTABLE  ok
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 1729 æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚<br>
<a name="lZYvh"></a></p>
<h2 id="è§£å†³">è§£å†³</h2>
<p>volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’</p>
<pre><code class="language-java">@JCStressTest
@Outcome(id = {&quot;1&quot;, &quot;4&quot;}, expect = Expect.ACCEPTABLE, desc = &quot;ok&quot;)
@Outcome(id = &quot;0&quot;, expect = Expect.ACCEPTABLE_INTERESTING, desc = &quot;!!!!&quot;)
@State
public class ConcurrencyTest {
    int num = 0;
    volatile boolean ready = false;
    @Actor
    public void actor1(I_Result r) {
        if(ready) {
            r.r1 = num + num;
        } else {
            r.r1 = 1;
        } 
    }
    
	@Actor
    public void actor2(I_Result r) {
        num = 2;
        ready = true;
    }
}
</code></pre>
<p>ç»“æœä¸º</p>
<pre><code>*** INTERESTING tests
  Some interesting behaviors observed. This is for the plain curiosity.
  0 matching test results.
</code></pre>
<p><a name="wGXgF"></a></p>
<h3 id="æœ‰åºæ€§ç†è§£">æœ‰åºæ€§ç†è§£</h3>
<p>JVM ä¼šåœ¨ä¸å½±å“æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œå¯ä»¥è°ƒæ•´è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œæ€è€ƒä¸‹é¢ä¸€æ®µä»£ç </p>
<pre><code class="language-java">static int i;
static int j;
// åœ¨æŸä¸ªçº¿ç¨‹å†…æ‰§è¡Œå¦‚ä¸‹èµ‹å€¼æ“ä½œ 
i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ
j = ...;
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè‡³äºæ˜¯å…ˆæ‰§è¡Œ i è¿˜æ˜¯ å…ˆæ‰§è¡Œ j ï¼Œå¯¹æœ€ç»ˆçš„ç»“æœä¸ä¼šäº§ç”Ÿå½±å“ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç çœŸæ­£æ‰§è¡Œ æ—¶ï¼Œæ—¢å¯ä»¥æ˜¯</p>
<pre><code class="language-java">i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ 
j = ...;
</code></pre>
<p>ä¹Ÿå¯ä»¥æ˜¯</p>
<pre><code class="language-java">j = ...;
i = ...; // è¾ƒä¸ºè€—æ—¶çš„æ“ä½œ
</code></pre>
<p>è¿™ç§ç‰¹æ€§ç§°ä¹‹ä¸ºã€æŒ‡ä»¤é‡æ’ã€ï¼Œå¤šçº¿ç¨‹ä¸‹ã€æŒ‡ä»¤é‡æ’ã€ä¼šå½±å“æ­£ç¡®æ€§ï¼Œä¾‹å¦‚è‘—åçš„ double-checked locking æ¨¡å¼å®ç°å•ä¾‹</p>
<pre><code class="language-java">public final class Singleton {
    private Singleton() { }
    private static Singleton INSTANCE = null;
    public static Singleton getInstance() {
		// å®ä¾‹æ²¡åˆ›å»ºï¼Œæ‰ä¼šè¿›å…¥å†…éƒ¨çš„ synchronizedä»£ç å— 
        if (INSTANCE == null) {
            synchronized (Singleton.class) {
                // ä¹Ÿè®¸æœ‰å…¶å®ƒçº¿ç¨‹å·²ç»åˆ›å»ºå®ä¾‹ï¼Œæ‰€ä»¥å†åˆ¤æ–­ä¸€æ¬¡ 
                if (INSTANCE == null) {
                    INSTANCE = new Singleton();
                }
            } 
        }
        return INSTANCE;
    }
}
</code></pre>
<p>ä»¥ä¸Šå®ç°çš„ç‰¹ç‚¹æ˜¯</p>
<ul>
<li>æ‡’æƒ°å®ä¾‹åŒ–</li>
<li>é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”</li>
</ul>
<p>ä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œ INSTANCE = new Singleton() å¯¹åº”çš„å­—èŠ‚ç ä¸º:</p>
<pre><code>0: new           #2						// class cn/itcast/jvm/t4/Singleton
3: dup
4: invokespecial #3						// Method &quot;&lt;init&gt;&quot;:()V
7: putstatic     #4						// Field INSTANCE:Lcn/itcast/jvm/t4/Singleton;
</code></pre>
<p>å…¶ä¸­4 7 ä¸¤æ­¥çš„é¡ºåºä¸æ˜¯å›ºå®šçš„ï¼Œä¹Ÿè®¸ jvm ä¼šä¼˜åŒ–ä¸º:å…ˆå°†å¼•ç”¨åœ°å€èµ‹å€¼ç»™ INSTANCE å˜é‡åï¼Œå†æ‰§è¡Œ æ„é€ æ–¹æ³•ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹ t1ï¼Œt2 æŒ‰å¦‚ä¸‹æ—¶é—´åºåˆ—æ‰§è¡Œ:</p>
<pre><code>æ—¶é—´1 t1 çº¿ç¨‹æ‰§è¡Œåˆ° INSTANCE = new Singleton();
æ—¶é—´2 t1 çº¿ç¨‹åˆ†é…ç©ºé—´ï¼Œä¸ºSingletonå¯¹è±¡ç”Ÿæˆäº†å¼•ç”¨åœ°å€(0 å¤„)
æ—¶é—´3 t1 çº¿ç¨‹å°†å¼•ç”¨åœ°å€èµ‹å€¼ç»™ INSTANCEï¼Œè¿™æ—¶ INSTANCE != null(7 å¤„)
æ—¶é—´4 t2 çº¿ç¨‹è¿›å…¥getInstance() æ–¹æ³•ï¼Œå‘ç° INSTANCE != null(synchronizedå—å¤–)ï¼Œç›´æ¥ è¿”å› INSTANCE
æ—¶é—´5 t1 çº¿ç¨‹æ‰§è¡ŒSingletonçš„æ„é€ æ–¹æ³•(4 å¤„)
</code></pre>
<p>è¿™æ—¶ t1 è¿˜æœªå®Œå…¨å°†æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå¦‚æœåœ¨æ„é€ æ–¹æ³•ä¸­è¦æ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæ¯•çš„å•ä¾‹<br />å¯¹ INSTANCE ä½¿ç”¨ volatile ä¿®é¥°å³å¯ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’ï¼Œä½†è¦æ³¨æ„åœ¨ JDK 5 ä»¥ä¸Šçš„ç‰ˆæœ¬çš„ volatile æ‰ ä¼šçœŸæ­£æœ‰æ•ˆ<br>
<a name="ac7Rj"></a></p>
<h2 id="happens-before">happens-before</h2>
<p>happens-before è§„å®šäº†å“ªäº›å†™æ“ä½œå¯¹å…¶å®ƒçº¿ç¨‹çš„è¯»æ“ä½œå¯è§ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“ï¼Œ æŠ›å¼€ä»¥ä¸‹ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„å†™ï¼Œå¯¹äºå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å…±äº«å˜é‡çš„è¯»å¯è§</p>
<ul>
<li>çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</li>
</ul>
<pre><code class="language-java">static int x;
static Object m = new Object();
new Thread(()-&gt;{
    synchronized(m) {
		x = 10; 
    }
},&quot;t1&quot;).start();

new Thread(()-&gt;{
    synchronized(m) {
        System.out.println(x);
    }
},&quot;t2&quot;).start();
</code></pre>
<ul>
<li>çº¿ç¨‹å¯¹volatileå˜é‡çš„å†™ï¼Œå¯¹æ¥ä¸‹æ¥å…¶ä»–çº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</li>
</ul>
<pre><code class="language-java">volatile static int x;
new Thread(()-&gt;{
    x = 10;
},&quot;t1&quot;).start();
new Thread(()-&gt;{
    System.out.println(x);
},&quot;t2&quot;).start();
</code></pre>
<ul>
<li>çº¿ç¨‹startå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§</li>
</ul>
<pre><code class="language-java">static int x;
x = 10;
new Thread(()-&gt;{
    System.out.println(x);
},&quot;t2&quot;).start();
</code></pre>
<ul>
<li>çº¿ç¨‹ç»“æŸå‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¾—çŸ¥å®ƒç»“æŸåçš„è¯»å¯è§(æ¯”å¦‚å…¶å®ƒçº¿ç¨‹è°ƒç”¨ t1.isAlive() æˆ– t1.join()ç­‰å¾…å®ƒç»“æŸ)</li>
</ul>
<pre><code class="language-java">static int x;
Thread t1 = new Thread(()-&gt;{
    x = 10;
},&quot;t1&quot;);
t1.start();

t1.join();
System.out.println(x);
</code></pre>
<ul>
<li>çº¿ç¨‹ t1 æ‰“æ–­ t2(interrupt)å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹äºå…¶ä»–çº¿ç¨‹å¾—çŸ¥ t2 è¢«æ‰“æ–­åå¯¹å˜é‡çš„è¯»å¯è§(é€š è¿‡t2.interrupted æˆ– t2.isInterrupted)</li>
</ul>
<pre><code class="language-java">static int x;
public static void main(String[] args) {
    Thread t2 = new Thread(()-&gt;{
        while(true) {
            if(Thread.currentThread().isInterrupted()) {
                System.out.println(x);
				break; 
            }
        } 
    },&quot;t2&quot;);
	t2.start();
    
    new Thread(()-&gt;{
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
		x = 10;
        t2.interrupt();
    },&quot;t1&quot;).start();
    while(!t2.isInterrupted()) {
        Thread.yield();
    }
    System.out.println(x);
}
</code></pre>
<ul>
<li>å¯¹å˜é‡é»˜è®¤å€¼(0ï¼Œfalseï¼Œnull)çš„å†™ï¼Œå¯¹å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</li>
<li>å…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœ x hb-&gt; y å¹¶ä¸” y hb-&gt; z é‚£ä¹ˆæœ‰ x hb-&gt; z</li>
</ul>
<blockquote>
<p>å˜é‡éƒ½æ˜¯æŒ‡æˆå‘˜å˜é‡æˆ–é™æ€æˆå‘˜å˜é‡<br>
å‚è€ƒ: ç¬¬17é¡µ</p>
</blockquote>
<p><a name="pnhX8"></a></p>
<h1 id="casä¸åŸå­ç±»">CASä¸åŸå­ç±»</h1>
<p><a name="uALee"></a></p>
<h2 id="cas">CAS</h2>
<p>CAS å³ Compare and Swap ï¼Œå®ƒä½“ç°çš„ä¸€ç§ä¹è§‚é”çš„æ€æƒ³ï¼Œæ¯”å¦‚å¤šä¸ªçº¿ç¨‹è¦å¯¹ä¸€ä¸ªå…±äº«çš„æ•´å‹å˜é‡æ‰§è¡Œ +1 æ“ä½œ:</p>
<pre><code class="language-java">// éœ€è¦ä¸æ–­å°è¯• 
while(true) {
    int æ—§å€¼ = å…±äº«å˜é‡ ; // æ¯”å¦‚æ‹¿åˆ°äº†å½“å‰å€¼ 0
    int ç»“æœ = æ—§å€¼ +1;// åœ¨æ—§å€¼ 0 çš„åŸºç¡€ä¸Šå¢åŠ  1 ï¼Œæ­£ç¡®ç»“æœæ˜¯ 1
    /*
    è¿™æ—¶å€™å¦‚æœåˆ«çš„çº¿ç¨‹æŠŠå…±äº«å˜é‡æ”¹æˆäº† 5ï¼Œæœ¬çº¿ç¨‹çš„æ­£ç¡®ç»“æœ 1 å°±ä½œåºŸäº†ï¼Œè¿™æ—¶å€™ 
    compareAndSwap è¿”å› falseï¼Œé‡æ–°å°è¯•ï¼Œç›´åˆ°:
    compareAndSwap è¿”å› trueï¼Œè¡¨ç¤ºæˆ‘æœ¬çº¿ç¨‹åšä¿®æ”¹çš„åŒæ—¶ï¼Œåˆ«çš„çº¿ç¨‹æ²¡æœ‰å¹²æ‰°
    */
    if( compareAndSwap ( æ—§å€¼, ç»“æœ )) { 
        // æˆåŠŸï¼Œé€€å‡ºå¾ªç¯
    } 
}
</code></pre>
<p>è·å–å…±äº«å˜é‡æ—¶ï¼Œä¸ºäº†ä¿è¯è¯¥å˜é‡çš„å¯è§æ€§ï¼Œéœ€è¦ä½¿ç”¨ volatile ä¿®é¥°ã€‚ç»“åˆ CAS å’Œ volatile å¯ä»¥å®ç°æ— é”å¹¶å‘ï¼Œé€‚ç”¨äºç«äº‰ä¸æ¿€çƒˆã€å¤šæ ¸ CPU çš„åœºæ™¯ä¸‹ã€‚</p>
<ul>
<li>å› ä¸ºæ²¡æœ‰ä½¿ç”¨ synchronizedï¼Œæ‰€ä»¥çº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œè¿™æ˜¯æ•ˆç‡æå‡çš„å› ç´ ä¹‹ä¸€</li>
<li>ä½†å¦‚æœç«äº‰æ¿€çƒˆï¼Œå¯ä»¥æƒ³åˆ°é‡è¯•å¿…ç„¶é¢‘ç¹å‘ç”Ÿï¼Œåè€Œæ•ˆç‡ä¼šå—å½±å“</li>
</ul>
<p>CAS åº•å±‚ä¾èµ–äºä¸€ä¸ª Unsafe ç±»æ¥ç›´æ¥è°ƒç”¨æ“ä½œç³»ç»Ÿåº•å±‚çš„ CAS æŒ‡ä»¤ï¼Œä¸‹é¢æ˜¯ç›´æ¥ä½¿ç”¨ Unsafe å¯¹è±¡è¿› è¡Œçº¿ç¨‹å®‰å…¨ä¿æŠ¤çš„ä¸€ä¸ªä¾‹å­</p>
<pre><code class="language-java">import sun.misc.Unsafe;
import java.lang.reflect.Field;
public class TestCAS {
    public static void main(String[] args) throws InterruptedException {
        DataContainer dc = new DataContainer();
        int count = 5;
        Thread t1 = new Thread(() -&gt; {
    		for (int i = 0; i &lt; count; i++) {
                dc.increase();
            }
        });
        t1.start();
        t1.join();
        System.out.println(dc.getData());
    }
}

class DataContainer {
    private volatile int data;
    static final Unsafe unsafe;
    static final long DATA_OFFSET;
	static { 
        try {
            // Unsafe å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ï¼Œåªèƒ½é€šè¿‡åå°„è·å¾—
            Field theUnsafe = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;); 
            theUnsafe.setAccessible(true);
            unsafe = (Unsafe) theUnsafe.get(null);
        } catch (NoSuchFieldException | IllegalAccessException e) {
            throw new Error(e);
        } try {
            // data å±æ€§åœ¨ DataContainer å¯¹è±¡ä¸­çš„åç§»é‡ï¼Œç”¨äº Unsafe ç›´æ¥è®¿é—®è¯¥å±æ€§
            DATA_OFFSET = unsafe.objectFieldOffset(DataContainer.class.getDeclaredField(&quot;data&quot;));
        } catch (NoSuchFieldException e) {
            throw new Error(e);
        } 
    }
    
    public void increase() {
        int oldValue;
        while(true) {
            // è·å–å…±äº«å˜é‡æ—§å€¼ï¼Œå¯ä»¥åœ¨è¿™ä¸€è¡ŒåŠ å…¥æ–­ç‚¹ï¼Œä¿®æ”¹ data è°ƒè¯•æ¥åŠ æ·±ç†è§£
            oldValue = data;
            // cas å°è¯•ä¿®æ”¹ data ä¸º æ—§å€¼ + 1ï¼Œå¦‚æœæœŸé—´æ—§å€¼è¢«åˆ«çš„çº¿ç¨‹æ”¹äº†ï¼Œè¿”å› false
            if (unsafe.compareAndSwapInt(this, DATA_OFFSET, oldValue, oldValue + 1)){
                return; 
            }
        }
    }
    
    public void decrease() {
    	int oldValue;
        while(true){
            oldValue = data;
    		if (unsafe.compareAndSwapInt(this, DATA_OFFSET, oldValue, oldValue - 1)){
                return;
            }
        }
    }
    public int getData() {
        return data;
    } 
}
</code></pre>
<p><a name="amqXK"></a></p>
<h2 id="ä¹è§‚é”ä¸æ‚²è§‚é”">ä¹è§‚é”ä¸æ‚²è§‚é”</h2>
<ul>
<li>CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³:æœ€ä¹è§‚çš„ä¼°è®¡ï¼Œä¸æ€•åˆ«çš„çº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œå°±ç®—æ”¹äº†ä¹Ÿæ²¡å…³ç³»ï¼Œ æˆ‘åƒäºç‚¹å†é‡è¯•å‘—ã€‚</li>
<li>synchronized æ˜¯åŸºäºæ‚²è§‚é”çš„æ€æƒ³:æœ€æ‚²è§‚çš„ä¼°è®¡ï¼Œå¾—é˜²ç€å…¶å®ƒçº¿ç¨‹æ¥ä¿®æ”¹å…±äº«å˜é‡ï¼Œæˆ‘ä¸Šäº†é” ä½ ä»¬éƒ½åˆ«æƒ³æ”¹ï¼Œæˆ‘æ”¹å®Œäº†è§£å¼€é”ï¼Œä½ ä»¬æ‰æœ‰æœºä¼šã€‚<br>
<a name="yAZIy"></a></li>
</ul>
<h2 id="åŸå­æ“ä½œç±»">åŸå­æ“ä½œç±»</h2>
<p>juc(java.util.concurrent)ä¸­æä¾›äº†åŸå­æ“ä½œç±»ï¼Œå¯ä»¥æä¾›çº¿ç¨‹å®‰å…¨çš„æ“ä½œï¼Œä¾‹å¦‚:AtomicIntegerã€<br />AtomicBooleanç­‰ï¼Œå®ƒä»¬åº•å±‚å°±æ˜¯é‡‡ç”¨ CAS æŠ€æœ¯ + volatile æ¥å®ç°çš„ã€‚ å¯ä»¥ä½¿ç”¨ AtomicInteger æ”¹å†™ä¹‹å‰çš„ä¾‹å­:</p>
<pre><code class="language-java">// åˆ›å»ºåŸå­æ•´æ•°å¯¹è±¡
private static AtomicInteger i = new AtomicInteger(0);
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread(() -&gt; {
        for (int j = 0; j &lt; 5000; j++) { 
            i.getAndIncrement(); // è·å–å¹¶ä¸”è‡ªå¢ i++
            //i.incrementAndGet(); // è‡ªå¢å¹¶ä¸”è·å– ++i
        } 
    });
    Thread t2 = new Thread(() -&gt; {
        for (int j = 0; j &lt; 5000; j++) {
            i.getAndDecrement(); // è·å–å¹¶ä¸”è‡ªå‡ i-- 
        }
    });
    
    t1.start();
    t2.start();
    t1.join();
    t2.join();
    System.out.println(i);
}
</code></pre>
<p><a name="liIpj"></a></p>
<h1 id="sychronizedä¼˜åŒ–">sychronizedä¼˜åŒ–</h1>
<p>Java HotSpotè™šæ‹Ÿæœºä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å¯¹è±¡å¤´(åŒ…æ‹¬ class æŒ‡é’ˆå’Œ Mark Word)ã€‚Mark Word å¹³æ—¶å­˜å‚¨è¿™ä¸ªå¯¹è±¡çš„<code>å“ˆå¸Œç ã€åˆ†ä»£å¹´é¾„(ä»å¹¸å­˜åŒºæ™‹å‡åˆ°è€å¹´ä»£ä¼šç”¨åˆ°)</code>ï¼Œå½“åŠ é”æ—¶ï¼Œè¿™äº›ä¿¡æ¯å°±æ ¹æ®æƒ…å†µè¢«æ›¿æ¢ä¸º<code>æ ‡è®°ä½(é”çš„ç±»å‹)</code>ã€<code>çº¿ç¨‹é”è®°å½•æŒ‡é’ˆ</code>ã€<code>é‡é‡çº§é”æŒ‡é’ˆ</code>ã€<code>çº¿ç¨‹ID</code>ç­‰å†…å®¹<br>
<a name="KYHSb"></a></p>
<h2 id="è½»é‡çº§é”">è½»é‡çº§é”</h2>
<p>å¦‚æœä¸€ä¸ªå¯¹è±¡è™½ç„¶æœ‰å¤šçº¿ç¨‹è®¿é—®ï¼Œä½†å¤šçº¿ç¨‹è®¿é—®çš„æ—¶é—´æ˜¯é”™å¼€çš„(ä¹Ÿå°±æ˜¯æ²¡æœ‰ç«äº‰)ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ã€‚è¿™å°±å¥½æ¯”:<br />å­¦ç”Ÿ(çº¿ç¨‹ A)ç”¨è¯¾æœ¬å åº§ï¼Œä¸Šäº†åŠèŠ‚è¯¾ï¼Œå‡ºé—¨äº†(CPUæ—¶é—´åˆ°)ï¼Œå›æ¥ä¸€çœ‹ï¼Œå‘ç°è¯¾æœ¬æ²¡å˜ï¼Œè¯´æ˜æ²¡æœ‰ç«äº‰ï¼Œç»§ç»­ä¸Šä»–çš„è¯¾ã€‚<br />å¦‚æœè¿™æœŸé—´æœ‰å…¶å®ƒå­¦ç”Ÿ(çº¿ç¨‹ B)æ¥äº†ï¼Œä¼šå‘ŠçŸ¥(çº¿ç¨‹A)æœ‰å¹¶å‘è®¿é—®ï¼Œçº¿ç¨‹ A éšå³å‡çº§ä¸ºé‡é‡çº§é”(é”è†¨èƒ€)ï¼Œ è¿›å…¥é‡é‡çº§é”çš„æµç¨‹ã€‚<br />è€Œé‡é‡çº§é”å°±ä¸æ˜¯é‚£ä¹ˆç”¨è¯¾æœ¬å åº§é‚£ä¹ˆç®€å•äº†ï¼Œå¯ä»¥æƒ³è±¡çº¿ç¨‹ A èµ°ä¹‹å‰ï¼ŒæŠŠåº§ä½ç”¨ä¸€ä¸ªé“æ …æ å›´èµ·æ¥ <br />å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”</p>
<pre><code class="language-java">static Object obj = new Object();
public static void method1() {
    synchronized( obj ) { 
        // åŒæ­¥å— A
        method2(); 
    }
}
public static void method2() {
	synchronized( obj ) { 
        // åŒæ­¥å— B
    } 
}
</code></pre>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½çš„æ ˆå¸§éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå†…éƒ¨å¯ä»¥å­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word</p>
<ul>
<li>å¦‚æœåŠ é”MarkWordä¸­çš„å†…å®¹éœ€è¦å‘ç”Ÿæ”¹å˜ï¼Œéœ€è¦æŠŠåŸæ¥çš„å†…å®¹ä¿å­˜èµ·æ¥</li>
<li>åŠ é”æ—¶å°†é”è®°å½•åœ°å€ç»™MarkWord</li>
<li>ç­‰è§£é”åï¼Œéœ€è¦æŠŠåŸæ¥çš„å†…å®¹è¿˜ç»™MarkWord</li>
</ul>
<p><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646029795880-2166b3ce-3e43-4645-bc27-c0943ede2098-20220312195457959.png" alt="image.png" loading="lazy"><br>
<a name="GVmLp"></a></p>
<h2 id="é”è†¨èƒ€">é”è†¨èƒ€</h2>
<p>å¦‚æœåœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œè¿™æ—¶ä¸€ç§æƒ…å†µå°±æ˜¯æœ‰å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”(æœ‰ç«äº‰)ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸ºé‡é‡çº§é”ã€‚<br />çº¿ç¨‹ä¸€è§£é”å¤±è´¥ï¼Œæ˜¯ä¸ºäº†å‘Šè¯‰çº¿ç¨‹ä¸€ç°åœ¨æ˜¯ä¸€ä¸ªé‡é‡çº§é”ï¼Œéœ€è¦æŒ‰ç…§é‡é‡çº§é”çš„æ–¹å¼æ¥è§£é”<br />MarkWordä¸­å¢åŠ é‡é‡çº§é”ï¼Œæ˜¯ä¸ºäº†å”¤é†’é˜»å¡ä¸­çš„çº¿ç¨‹</p>
<pre><code class="language-java">static Object obj = new Object();
public static void method1() {
    synchronized( obj ) { 
        // åŒæ­¥å—
    } 
}
</code></pre>
<p><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646029841309-0a32d3b3-ef4f-4408-8fa7-eee7e9b2e834-20220312195458112.png" alt="image.png" loading="lazy"><br>
<a name="bir5r"></a></p>
<h2 id="é‡é‡é”">é‡é‡é”</h2>
<p>é‡é‡çº§é”ç«äº‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥ä½¿ç”¨è‡ªæ—‹æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è‡ªæ—‹æˆåŠŸ(å³è¿™æ—¶å€™æŒé”çº¿ç¨‹å·²ç»é€€<br />å‡ºäº†åŒæ­¥å—ï¼Œé‡Šæ”¾äº†é”)ï¼Œè¿™æ—¶å½“å‰çº¿ç¨‹å°±å¯ä»¥é¿å…é˜»å¡ã€‚<br />åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½ æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡;åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ€»ä¹‹ï¼Œæ¯”è¾ƒæ™ºèƒ½ã€‚</p>
<ul>
<li>è‡ªæ—‹ä¼šå ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚</li>
<li>å¥½æ¯”ç­‰çº¢ç¯æ—¶æ±½è½¦æ˜¯ä¸æ˜¯ç†„ç«ï¼Œä¸ç†„ç«ç›¸å½“äºè‡ªæ—‹(ç­‰å¾…æ—¶é—´çŸ­äº†åˆ’ç®—)ï¼Œç†„ç«äº†ç›¸å½“äºé˜»å¡(ç­‰å¾…æ—¶é—´é•¿äº†åˆ’ç®—)</li>
<li>Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½</li>
</ul>
<p>è‡ªæ—‹é‡è¯•æˆåŠŸçš„æƒ…å†µ<br /><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646029915647-8fd9e65d-8b3f-4e7f-a652-624e33f238bc-20220312195458194.png" alt="image.png" loading="lazy"><br />è‡ªæ—‹é‡è¯•å¤±è´¥çš„æƒ…å†µ<br /><img src="http://yuanye1107.oss-cn-shanghai.aliyuncs.com/img/1646030033037-30d2cfb0-3494-4d8a-b26c-bdfb1ed8f1dc-20220312195458290.png" alt="image.png" loading="lazy"><br>
<a name="YdRr4"></a></p>
<h2 id="åå‘é”">åå‘é”</h2>
<p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶(å°±è‡ªå·±è¿™ä¸ªçº¿ç¨‹)ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œã€‚Java 6 ä¸­å¼•å…¥äº†åå‘é”æ¥åšè¿›ä¸€æ­¥ä¼˜åŒ–:åªæœ‰ç¬¬ä¸€æ¬¡ä½¿ç”¨ CAS å°†çº¿ç¨‹ IDè®¾ç½®åˆ°å¯¹è±¡çš„ Mark Word å¤´ï¼Œä¹‹åå‘ç°è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œä¸ç”¨é‡æ–° CAS.</p>
<ul>
<li>å˜ä¸ºé‡é‡çº§é”æ—¶éœ€è¦æ’¤é”€åå‘é”ï¼Œæ’¤é”€åå‘é”éœ€è¦å°†æŒé”çº¿ç¨‹å‡çº§ä¸ºè½»é‡çº§é”ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æ‰€æœ‰çº¿ç¨‹éœ€è¦æš‚åœ(STW)</li>
<li>è®¿é—®å¯¹è±¡çš„ hashCode ä¹Ÿä¼šæ’¤é”€åå‘é”
<ul>
<li>å½“ä¸€ä¸ªå¯¹è±¡å·²ç»è®¡ç®—è¿‡identity hash code(æœªè¢«è¦†å†™çš„ java.lang.Object.hashCode() æˆ–è€… java.lang.System.identityHashCode(Object) æ‰€è¿”å›çš„å€¼)ï¼Œå®ƒå°±æ— æ³•è¿›å…¥åå‘é”çŠ¶æ€ï¼›</li>
<li>å½“ä¸€ä¸ªå¯¹è±¡å½“å‰æ­£å¤„äºåå‘é”çŠ¶æ€ï¼Œå¹¶ä¸”éœ€è¦è®¡ç®—å…¶identity hash codeçš„è¯ï¼Œåˆ™å®ƒçš„åå‘é”ä¼šè¢«æ’¤é”€ï¼Œå¹¶ä¸”é”ä¼šè†¨èƒ€ä¸ºé‡é‡é”ï¼›</li>
<li>é‡é‡é”çš„å®ç°ä¸­ï¼ŒObjectMonitorç±»é‡Œæœ‰å­—æ®µå¯ä»¥è®°å½•éåŠ é”çŠ¶æ€ä¸‹çš„mark wordï¼Œå…¶ä¸­å¯ä»¥å­˜å‚¨identity hash codeçš„å€¼ã€‚æˆ–è€…ç®€å•è¯´å°±æ˜¯é‡é‡é”å¯ä»¥å­˜ä¸‹identity hash codeã€‚</li>
</ul>
</li>
<li>å¦‚æœå¯¹è±¡è™½ç„¶è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œ é‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ Thread ID</li>
<li>æ’¤é”€åå‘å’Œé‡åå‘éƒ½æ˜¯æ‰¹é‡è¿›è¡Œçš„ï¼Œä»¥ç±»ä¸ºå•ä½</li>
<li>å¦‚æœæ’¤é”€åå‘åˆ°è¾¾æŸä¸ªé˜ˆå€¼ï¼Œæ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„</li>
<li>å¯ä»¥ä¸»åŠ¨ä½¿ç”¨ -XX:-UseBiasedLocking ç¦ç”¨åå‘é”</li>
</ul>
<p>å¯ä»¥å‚è€ƒè¿™ç¯‡è®ºæ–‡:<a href="https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-">https://www.oracle.com/technetwork/java/biasedlocking-oopsla2006-wp-</a> 149958.pdf</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ªæ–¹æ³•åŒæ­¥å—ï¼Œåˆ©ç”¨åŒä¸€ä¸ªå¯¹è±¡åŠ é”</p>
<pre><code class="language-java">static Object obj = new Object();
public static void method1() {
    synchronized( obj ) { // åŒæ­¥å— A
    	method2(); 
    }
}

public static void method2() {
    synchronized( obj ) { 
        // åŒæ­¥å— B
    }
}
</code></pre>
<p>![image.png](https://cdn.nlark.com/yuque/0/2022/png/26092193/1646030118607-c926f2b8-b980-4c23-a77f-eec29106c721.png#clientId=ufbb25c08-b6bc-4&amp;crop=0&amp;crop=0&amp;crop=1&amp;crop=1&amp;from=paste&amp;height=249&amp;id=u81a5b064&amp;margin=[object Object]&amp;name=image.png&amp;originHeight=498&amp;originWidth=994&amp;originalType=binary&amp;ratio=1&amp;rotation=0&amp;showTitle=false&amp;size=82025&amp;status=done&amp;style=none&amp;taskId=u3c8466fd-b12d-42c7-a3c6-0f8793c0408&amp;title=&amp;width=497)<br>
<a name="coHn0"></a></p>
<h2 id="å…¶ä»–ä¼˜åŒ–">å…¶ä»–ä¼˜åŒ–</h2>
<p><a name="EsZnY"></a></p>
<h3 id="1-å‡å°‘ä¸Šé”æ—¶é—´">1. å‡å°‘ä¸Šé”æ—¶é—´</h3>
<p>åŒæ­¥ä»£ç å—ä¸­å°½é‡çŸ­(å‡å°‘çº¿ç¨‹äº¤é”™æ—¶é—´ï¼Œå°½é‡ä¿æŒä¸ºè½»é‡çº§é”)<br>
<a name="qFcfJ"></a></p>
<h3 id="2-å‡å°‘é”çš„ç²’åº¦">2. å‡å°‘é”çš„ç²’åº¦</h3>
<p>å°†ä¸€ä¸ªé”æ‹†åˆ†ä¸ºå¤šä¸ªé”æé«˜å¹¶å‘åº¦ï¼Œä¾‹å¦‚:</p>
<ul>
<li>ConcurrentHashMap</li>
<li>LongAdder åˆ†ä¸º base å’Œ cells ä¸¤éƒ¨åˆ†ã€‚æ²¡æœ‰å¹¶å‘äº‰ç”¨çš„æ—¶å€™æˆ–è€…æ˜¯ cells æ•°ç»„æ­£åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šä½¿ç”¨ CAS æ¥ç´¯åŠ å€¼åˆ° baseï¼Œæœ‰å¹¶å‘äº‰ç”¨ï¼Œä¼šåˆå§‹åŒ– cells æ•°ç»„ï¼Œæ•°ç»„æœ‰å¤šå°‘ä¸ª cellï¼Œå°±å…è®¸æœ‰å¤šå°‘çº¿ç¨‹å¹¶è¡Œä¿®æ”¹ï¼Œæœ€åå°†æ•°ç»„ä¸­æ¯ä¸ª cell ç´¯åŠ ï¼Œå†åŠ ä¸Š base å°±æ˜¯æœ€ç»ˆçš„å€¼</li>
<li>LinkedBlockingQueueå…¥é˜Ÿå’Œå‡ºé˜Ÿä½¿ç”¨ä¸åŒçš„é”ï¼Œç›¸å¯¹äºLinkedBlockingArrayåªæœ‰ä¸€ä¸ªé”æ•ˆç‡è¦é«˜<br>
<a name="UacE1"></a></li>
</ul>
<h3 id="3-é”ç²—åŒ–">3. é”ç²—åŒ–</h3>
<p>å¤šæ¬¡å¾ªç¯è¿›å…¥åŒæ­¥å—ä¸å¦‚åŒæ­¥å—å†…å¤šæ¬¡å¾ªç¯<br />å¦å¤– JVM å¯èƒ½ä¼šåšå¦‚ä¸‹ä¼˜åŒ–ï¼ŒæŠŠå¤šæ¬¡ append çš„åŠ é”æ“ä½œç²—åŒ–ä¸ºä¸€æ¬¡(å› ä¸ºéƒ½æ˜¯å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œ æ²¡å¿…è¦é‡å…¥å¤šæ¬¡)</p>
<pre><code class="language-java">new StringBuffer().append(&quot;a&quot;).append(&quot;b&quot;).append(&quot;c&quot;);
</code></pre>
<p><a name="bIIL2"></a></p>
<h3 id="4-é”æ¶ˆé™¤">4. é”æ¶ˆé™¤</h3>
<p>JVM ä¼šè¿›è¡Œä»£ç çš„é€ƒé€¸åˆ†æï¼Œä¾‹å¦‚æŸä¸ªåŠ é”å¯¹è±¡æ˜¯æ–¹æ³•å†…å±€éƒ¨å˜é‡ï¼Œä¸ä¼šè¢«å…¶å®ƒçº¿ç¨‹æ‰€è®¿é—®åˆ°ï¼Œè¿™æ—¶å€™å°±ä¼šè¢«å³æ—¶ç¼–è¯‘å™¨å¿½ç•¥æ‰æ‰€æœ‰åŒæ­¥æ“ä½œã€‚<br>
<a name="ARsKw"></a></p>
<h3 id="5-è¯»å†™åˆ†ç¦»">5. è¯»å†™åˆ†ç¦»</h3>
<p>CopyOnWriteArrayList<br />CopyOnWriteSet<br>
<a name="SOKfG"></a></p>
<h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<p><a href="https://wiki.openjdk.java.net/display/HotSpot/Synchronization">https://wiki.openjdk.java.net/display/HotSpot/Synchronization</a> <br /><a href="http://luojinping.com/2015/07/09/java%E9%94%81%E4%BC%98%E5%8C%96/">http://luojinping.com/2015/07/09/javaé”ä¼˜åŒ–/</a><br /><a href="https://www.infoq.cn/article/java-se-16-synchronized">https://www.infoq.cn/article/java-se-16-synchronized</a> <br /><a href="https://www.jianshu.com/p/9932047a89be">https://www.jianshu.com/p/9932047a89be</a> <br /><a href="https://www.cnblogs.com/sheeva/p/6366782.html">https://www.cnblogs.com/sheeva/p/6366782.html</a> <a href="https://stackoverflow.com/questions/46312817/does-java-ever-rebias-an-individual-lock">https://stackoverflow.com/questions/46312817/does-java-ever-rebias-an-individual-lock</a></p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">ä¸‹ä¸€ç¯‡</div>
                <a href="https://yeyuan1107.github.io/post/jvm-lei-jia-zai-yu-zi-jie-ma-ji-zhu/" class="post-title gt-a-link">
                    JVMç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯
                </a>
            </div>
        

        

        

        

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">æ¸©æ•…è€ŒçŸ¥æ–°</div>
    <div class="social-container">
        
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a>
    </div>
    <div>
        Theme <a href="https://github.com/imhanjie/gridea-theme-pure" target="_blank">Pure</a>, Powered by <a
                href="https://gridea.dev" target="_blank">Gridea</a> | <a href="https://yeyuan1107.github.io/atom.xml" target="_blank">RSS</a>
    </div>
</div>

<script>
  hljs.highlightAll()
</script>

    </div>
</div>
</body>
</html>
